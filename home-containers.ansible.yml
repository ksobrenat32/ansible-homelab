# Description: Ansible playbook to setup home containers for ucorepro
---
- name: Home Containers Setup for ucorepro
  hosts: ucorepro

  vars:
    deemix_data_dir: /mnt/disk/shared/containers/deemix
    jellyfin_data_dir: /mnt/disk/shared/containers/jellyfin
    media_dir: /mnt/disk/shared/media
    nextcloud_data_dir: /mnt/disk/shared/containers/nextcloud
    overleaf_data_dir: /mnt/disk/shared/containers/overleaf
    pyload_data_dir: /mnt/disk/shared/containers/pyload
    scholarships_data_dir: /mnt/disk/shared/containers/scholarships-db
    transmission_data_dir: /mnt/disk/shared/containers/transmission

  tasks:
    - name: Enable podman auto-update
      ansible.builtin.systemd:
        name: podman-auto-update
        scope: user
        enabled: true
        state: started

    - name: Create the home containers directory
      ansible.builtin.file:
        path: /home/core/.config/containers/systemd/
        state: directory
        owner: core
        group: core
        mode: "0755"

    - name: Copy all the quadlet files
      ansible.builtin.template:
        src: "files/containers/{{ item }}.j2"
        dest: "/home/core/.config/containers/systemd/{{ item }}"
        owner: core
        group: core
        mode: "0644"
      with_items:
        - "deemix.container"
        - "jellyfin.container"
        - "move_movies.container"
        - "nextcloud.pod"
        - "nextcloud-db.container"
        - "nextcloud-cache.container"
        - "nextcloud-app.container"
        - "overleaf.pod"
        - "overleaf-db.container"
        - "overleaf-cache.container"
        - "overleaf-app.container"
        - "pyload.container"
        - "stirling.container"
        - "scholarships.container"
        - "transmission.container"

    - name: Create the systemd user directory
      ansible.builtin.file:
        path: /home/core/.config/systemd/user/
        state: directory
        owner: core
        group: core
        mode: "0755"

    - name: Copy the systemd service files for timers
      ansible.builtin.template:
        src: "files/containers/{{ item }}.j2"
        dest: "/home/core/.config/systemd/user/{{ item }}"
        owner: core
        group: core
        mode: "0644"
      with_items:
        - "nextcloud-timer.service"
        - "nextcloud-timer.timer"

    - name: Start systemd containers
      ansible.builtin.systemd:
        name: "{{ item }}"
        scope: user
        state: started
        daemon_reload: true
      with_items:
        - "deemix.service"
        - "jellyfin.service"
        - "move_movies.service"
        - "nextcloud-pod.service"
        - "nextcloud-db.service"
        - "nextcloud-cache.service"
        - "nextcloud-app.service"
        - "overleaf-pod.service"
        - "overleaf-db.service"
        - "overleaf-cache.service"
        - "overleaf-app.service"
        - "pyload.service"
        - "stirling.service"
        - "scholarships.service"
        - "transmission.service"
        - "nextcloud-timer.service"
        - "nextcloud-timer.timer"
